<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
 PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
  "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.example.project_server.repository.CertificateRepository">

    <select id="getCertRank" parameterType="map"
            resultType="com.example.project_server.vo.Certificate">
        SELECT C.*, COUNT(CM.certId) AS extra__certCount
        FROM certMention CM
        JOIN certificate C ON CM.certId = C.id
        WHERE (#{jobCatId} = 0 OR CM.jobCatId = #{jobCatId})
          AND (#{jobCodeId} = 0 OR CM.jobCodeId = #{jobCodeId})
        GROUP BY CM.certId
        ORDER BY extra__certCount DESC
        LIMIT 7;
    </select>

    <select id="getJobCats"
            resultType="com.example.project_server.vo.JobCat">
        SELECT *
        FROM jobCat
        ORDER BY id;
    </select>

    <select id="getJobCodes" parameterType="int"
            resultType="com.example.project_server.vo.JobCode">
        SELECT *
        FROM jobCode
        WHERE jobCatId = #{jobCatId}
        ORDER BY id;
    </select>

    <select id="getJobCatById" parameterType="int">
        SELECT *
        FROM jobCat
        WHERE id = #{jobCatId}
    </select>

    <select id="getJobCodeById" parameterType="int">
        SELECT *
        FROM jobCode
        WHERE `code` = #{jobCodeId}
    </select>

    <select id="getMemberCerts" parameterType="int">
        SELECT *, ROW_NUMBER() OVER (PARTITION BY memberId ORDER BY startDate ASC) AS extra__rankNum
        FROM memberCert
        WHERE memberId = #{loginedMemberId}
        ORDER BY extra__rankNum DESC;
    </select>

    <select id="getPostCount" parameterType="map" resultType="int">
        SELECT COUNT(DISTINCT gno)
        FROM certmention
        <where>
            <if test="jobCatId != 0">
                jobCatId = #{jobCatId}
            </if>
            <if test="jobCodeId != 0">
                <if test="jobCatId != 0">
                    AND
                </if>
                jobCodeId = #{jobCodeId}
            </if>
        </where>
    </select>

    <select id="getCertCount" parameterType="map" resultType="int">
        SELECT COUNT(DISTINCT certId)
        FROM certmention
        <where>
            <if test="jobCatId != 0">
                jobCatId = #{jobCatId}
            </if>
            <if test="jobCodeId != 0">
                <if test="jobCatId != 0">
                    AND
                </if>
                jobCodeId = #{jobCodeId}
            </if>
        </where>
    </select>

    <select id="getMentionCount" parameterType="int" resultType="int">
        SELECT COUNT(*)
        FROM certmention
        <where>
            <if test="jobCatId != 0">
                jobCatId = #{jobCatId}
            </if>
            <if test="jobCodeId != 0">
                <if test="jobCatId != 0">
                    AND
                </if>
                jobCodeId = #{jobCodeId}
            </if>
        </where>
    </select>

    <select id="getCertByName" parameterType="String">
        SELECT *
        FROM certificate
        WHERE `name` = #{certname}
    </select>

    <insert id="doAdd" parameterType="map">
        INSERT INTO memberCert
        SET
            memberId = #{memberId},
            certId = #{certId},
            certname = #{certname},
            certificateNumber = #{certificateNumber},
            startDate = #{startDate},
            endDate = #{endDate},
            regDate = NOW(),
            updateDate = NOW()
    </insert>

</mapper>
